
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>EF ObjectContext.Attach and ObjectStateManager - Felipe Lima</title>
  <meta name="author" content="Felipe Lima">

  
  <meta name="description" content="When working with the Entity Framework, you&rsquo;ve got to be extremely careful when exchanging Entities between different ObjectContexts. You &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://felipecsl.github.com/blog/2009/07/02/ef-objectcontext-attach-and-objectstatemanager/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Felipe Lima" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Felipe Lima</a></h1>
  
    <h2>weblog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:felipecsl.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">EF ObjectContext.Attach and ObjectStateManager</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-02T00:30:00-07:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>When working with the Entity Framework, you&rsquo;ve got to be extremely careful when exchanging Entities between different ObjectContexts. You probably know that if you want to modify an Entity which is already added to the database, you have to first attach it to the context before modifying it, so that EF can keep track of the changes you made to that instance and save them to the database later. There is a good reference page at msdn about <a href="http://msdn.microsoft.com/en-us/library/bb896271.aspx">attaching related objects</a>.</p>

<p>Attach assumes your Entity has not been changed while it was not being tracked by the ObjectContext. Otherwise, call <strong>ApplyPropertyChanges</strong> to attach and apply the changes.</p>

<p>Yesterday, I lost almost my entire day trying to translate this exception I was getting in ObjectContext.Attach():</p>

<p>&ldquo;<strong>System.InvalidOperationException : An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key.</strong>&rdquo;</p>

<p>EF complains that the Entity you&rsquo;re trying to add actually has an EntityKey identical to one that is already in the database. Okay, this seems obvious to me, since this is the actual purpose of Attach &ndash; start tracking changes objects that already exist in the database.</p>

<p>After an entire afternoon searching for an answer, I came accross some pages with other issues related to Attach that some people had, as well some solutions for <a href="http://www.codeproject.com/KB/architecture/attachobjectgraph.aspx">them</a>.</p>

<p>Today I re-read the exception message and the answer just popped on my face: &ldquo;<strong>I&rsquo;m already tracking the object you&rsquo;re trying to Attach, dumbass!</strong>&rdquo;. In fact, you cannot Attach an object to an ObjectContext if that object somehow has been already cached by the ObjectStateManager.</p>

<p>Let me exemplify:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;&lt;span class="kwrd"&gt;public&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; UpdateUserBooks(User _user)






&lt;span class="lnum"&gt;   2:  &lt;/span&gt;{






&lt;span class="lnum"&gt;   3:  &lt;/span&gt;    &lt;span class="kwrd"&gt;using&lt;/span&gt; (DataEntities db = &lt;span class="kwrd"&gt;new&lt;/span&gt; DataEntities())






&lt;span class="lnum"&gt;   4:  &lt;/span&gt;    {






&lt;span class="lnum"&gt;   5:  &lt;/span&gt;        Book userBook = (from b &lt;span class="kwrd"&gt;in&lt;/span&gt; db.Book.Include(&lt;span class="str"&gt;"Users"&lt;/span&gt;)






&lt;span class="lnum"&gt;   6:  &lt;/span&gt;                        select b).FirstOrDefault();






&lt;span class="lnum"&gt;   7:  &lt;/span&gt;






&lt;span class="lnum"&gt;   8:  &lt;/span&gt;        db.Attach(_user);    &lt;span class="rem"&gt;// throws InvalidOperationException&lt;/span&gt;






&lt;span class="lnum"&gt;   9:  &lt;/span&gt;        userBook.Users.Add(_user);






&lt;span class="lnum"&gt;  10:  &lt;/span&gt;        db.SaveChanges();






&lt;span class="lnum"&gt;  11:  &lt;/span&gt;    }






&lt;span class="lnum"&gt;  12:  &lt;/span&gt;}
</code></pre>

<p>What is happening? Your userBook query returns all the Books from the database <strong>AND</strong> their related Users (the Include was there for a reason). When you try to attach your User after_user after the query has been run, the ObjectContext already has _user under its hood, so trying to Attach it will throw an InvalidOperationException.</p>

<p>The solution is very simple: Always attach all your Entities before doing any operation/query in your ObjectContext. This way, you avoid any double-tracking request. If the ObjectContext needs your Entity later, it will retrieve the instance you attached before and you&rsquo;re good to go! Follow the fixed code:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;&lt;span class="kwrd"&gt;public&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; UpdateUserBooks(User _user)






&lt;span class="lnum"&gt;   2:  &lt;/span&gt;{






&lt;span class="lnum"&gt;   3:  &lt;/span&gt;    &lt;span class="kwrd"&gt;using&lt;/span&gt; (DataEntities db = &lt;span class="kwrd"&gt;new&lt;/span&gt; DataEntities())






&lt;span class="lnum"&gt;   4:  &lt;/span&gt;    {






&lt;span class="lnum"&gt;   5:  &lt;/span&gt;        db.Attach(_user);    &lt;span class="rem"&gt;// works fine!&lt;/span&gt;






&lt;span class="lnum"&gt;   6:  &lt;/span&gt;






&lt;span class="lnum"&gt;   7:  &lt;/span&gt;        Book userBook = (from b &lt;span class="kwrd"&gt;in&lt;/span&gt; db.Book.Include(&lt;span class="str"&gt;"Users"&lt;/span&gt;)






&lt;span class="lnum"&gt;   8:  &lt;/span&gt;                        select b).FirstOrDefault();






&lt;span class="lnum"&gt;   9:  &lt;/span&gt;






&lt;span class="lnum"&gt;  10:  &lt;/span&gt;        userBook.Users.Add(_user);






&lt;span class="lnum"&gt;  11:  &lt;/span&gt;        db.SaveChanges();






&lt;span class="lnum"&gt;  12:  &lt;/span&gt;    }






&lt;span class="lnum"&gt;  13:  &lt;/span&gt;}
</code></pre>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Felipe Lima</span></span>

      








  


<time datetime="2009-07-02T00:30:00-07:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2009</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://felipecsl.github.com/blog/2009/07/02/ef-objectcontext-attach-and-objectstatemanager/" data-via="felipecsl" data-counturl="http://felipecsl.github.com/blog/2009/07/02/ef-objectcontext-attach-and-objectstatemanager/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2009/06/24/notimplementedexception-in-graphics-drawimage/" title="Previous Post: NotImplementedException in Graphics.DrawImage">&laquo; NotImplementedException in Graphics.DrawImage</a>
      
      
        <a class="basic-alignment right" href="/blog/2009/07/08/automatically-tracking-last-modification-datetime-in-table-column/" title="Next Post: Automatically tracking last modification date/time in table column">Automatically tracking last modification date/time in table column &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/03/31/starting-with-android-managing-images/">Starting with Android - managing images</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/31/when-two-identical-strings-are-different/">When two identical strings are different?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/14/getting-started-with-chef/">Getting started with Chef</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/05/protip-delete-words-on-iterm2-mac-osx/">Protip: Delete words on iTerm2 (Mac OSX)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/24/wombat-0-4-0-released/">Wombat 0.4.0 released!</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/felipecsl">@felipecsl</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'felipecsl',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<a href="mailto:felipe.lima@gmail.com" title="Pair program with me!">
  <img  src="http://pairprogramwith.me/badge.png"
        alt="Pair program with me!" style="width: 150px" />
</a>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Felipe Lima -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
