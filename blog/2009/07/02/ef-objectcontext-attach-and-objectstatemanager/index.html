
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>EF ObjectContext.Attach and ObjectStateManager - Felipe Lima</title>
  <meta name="author" content="Felipe Lima">

  
  <meta name="description" content="When working with the Entity Framework, you&rsquo;ve got to be extremely careful when exchanging Entities between different ObjectContexts. You &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://felipecsl.com/blog/2009/07/02/ef-objectcontext-attach-and-objectstatemanager">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Felipe Lima" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href='http://fonts.googleapis.com/css?family=Quattrocento+Sans|Roboto:400,300' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26310657-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


<body>
	<div class="container">
		<aside class="left">
			<div class="inner-left">
				<header>
					<img src="http://www.gravatar.com/avatar/7fd4ba468da56bb5330a6352c1b54f52?s=200" alt="Gravatar of Felipe Lima " title="Gravatar of Felipe Lima" class="profilepic" />
<hgroup>
  <h1><a href="/">Felipe Lima</a></h1>
  
    <h2 class="subtitle">@felipecsl</h2>
   
</hgroup>


				</header>
				<footer>
					<p>
	
		<a href="http://github.com/felipecsl" class="btn btn-dark">GitHub</a>
	
	
		<a href="http://twitter.com/felipecsl" class="btn btn-dark">Twitter</a>
	
</p>
				</footer>
			</div>
		</aside>
    	<section class="right">
    		<div class="inner-right">
    			<div id="posts">
    			  	<article class="post">
    
  <header>
    
      <h1 class="entry-title">EF ObjectContext.Attach and ObjectStateManager</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-02T04:30:00-03:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>When working with the Entity Framework, you&rsquo;ve got to be extremely careful when exchanging Entities between different ObjectContexts. You probably know that if you want to modify an Entity which is already added to the database, you have to first attach it to the context before modifying it, so that EF can keep track of the changes you made to that instance and save them to the database later. There is a good reference page at msdn about <a href="http://msdn.microsoft.com/en-us/library/bb896271.aspx">attaching related objects</a>.</p>

<p>Attach assumes your Entity has not been changed while it was not being tracked by the ObjectContext. Otherwise, call <strong>ApplyPropertyChanges</strong> to attach and apply the changes.</p>

<p>Yesterday, I lost almost my entire day trying to translate this exception I was getting in ObjectContext.Attach():</p>

<p>&ldquo;<strong>System.InvalidOperationException : An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key.</strong>&rdquo;</p>

<p>EF complains that the Entity you&rsquo;re trying to add actually has an EntityKey identical to one that is already in the database. Okay, this seems obvious to me, since this is the actual purpose of Attach &ndash; start tracking changes objects that already exist in the database.</p>

<p>After an entire afternoon searching for an answer, I came accross some pages with other issues related to Attach that some people had, as well some solutions for <a href="http://www.codeproject.com/KB/architecture/attachobjectgraph.aspx">them</a>.</p>

<p>Today I re-read the exception message and the answer just popped on my face: &ldquo;<strong>I&rsquo;m already tracking the object you&rsquo;re trying to Attach, dumbass!</strong>&rdquo;. In fact, you cannot Attach an object to an ObjectContext if that object somehow has been already cached by the ObjectStateManager.</p>

<p>Let me exemplify:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;&lt;span class="kwrd"&gt;public&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; UpdateUserBooks(User _user)






&lt;span class="lnum"&gt;   2:  &lt;/span&gt;{






&lt;span class="lnum"&gt;   3:  &lt;/span&gt;    &lt;span class="kwrd"&gt;using&lt;/span&gt; (DataEntities db = &lt;span class="kwrd"&gt;new&lt;/span&gt; DataEntities())






&lt;span class="lnum"&gt;   4:  &lt;/span&gt;    {






&lt;span class="lnum"&gt;   5:  &lt;/span&gt;        Book userBook = (from b &lt;span class="kwrd"&gt;in&lt;/span&gt; db.Book.Include(&lt;span class="str"&gt;"Users"&lt;/span&gt;)






&lt;span class="lnum"&gt;   6:  &lt;/span&gt;                        select b).FirstOrDefault();






&lt;span class="lnum"&gt;   7:  &lt;/span&gt;






&lt;span class="lnum"&gt;   8:  &lt;/span&gt;        db.Attach(_user);    &lt;span class="rem"&gt;// throws InvalidOperationException&lt;/span&gt;






&lt;span class="lnum"&gt;   9:  &lt;/span&gt;        userBook.Users.Add(_user);






&lt;span class="lnum"&gt;  10:  &lt;/span&gt;        db.SaveChanges();






&lt;span class="lnum"&gt;  11:  &lt;/span&gt;    }






&lt;span class="lnum"&gt;  12:  &lt;/span&gt;}
</code></pre>

<p>What is happening? Your userBook query returns all the Books from the database <strong>AND</strong> their related Users (the Include was there for a reason). When you try to attach your User after_user after the query has been run, the ObjectContext already has _user under its hood, so trying to Attach it will throw an InvalidOperationException.</p>

<p>The solution is very simple: Always attach all your Entities before doing any operation/query in your ObjectContext. This way, you avoid any double-tracking request. If the ObjectContext needs your Entity later, it will retrieve the instance you attached before and you&rsquo;re good to go! Follow the fixed code:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;&lt;span class="kwrd"&gt;public&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; UpdateUserBooks(User _user)






&lt;span class="lnum"&gt;   2:  &lt;/span&gt;{






&lt;span class="lnum"&gt;   3:  &lt;/span&gt;    &lt;span class="kwrd"&gt;using&lt;/span&gt; (DataEntities db = &lt;span class="kwrd"&gt;new&lt;/span&gt; DataEntities())






&lt;span class="lnum"&gt;   4:  &lt;/span&gt;    {






&lt;span class="lnum"&gt;   5:  &lt;/span&gt;        db.Attach(_user);    &lt;span class="rem"&gt;// works fine!&lt;/span&gt;






&lt;span class="lnum"&gt;   6:  &lt;/span&gt;






&lt;span class="lnum"&gt;   7:  &lt;/span&gt;        Book userBook = (from b &lt;span class="kwrd"&gt;in&lt;/span&gt; db.Book.Include(&lt;span class="str"&gt;"Users"&lt;/span&gt;)






&lt;span class="lnum"&gt;   8:  &lt;/span&gt;                        select b).FirstOrDefault();






&lt;span class="lnum"&gt;   9:  &lt;/span&gt;






&lt;span class="lnum"&gt;  10:  &lt;/span&gt;        userBook.Users.Add(_user);






&lt;span class="lnum"&gt;  11:  &lt;/span&gt;        db.SaveChanges();






&lt;span class="lnum"&gt;  12:  &lt;/span&gt;    }






&lt;span class="lnum"&gt;  13:  &lt;/span&gt;}
</code></pre>
</div>


</article>


        <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://felipecsl.com/blog/2009/07/02/ef-objectcontext-attach-and-objectstatemanager/" data-via="felipecsl" data-counturl="http://felipecsl.com/blog/2009/07/02/ef-objectcontext-attach-and-objectstatemanager/" >Tweet</a>
  
  
  
</div>





    			</div>
    			<footer id="footer">
    				<p class="credit">
  Copyright &copy; 2014 - Felipe Lima. Powered by <a href="http://octopress.org">Octopress</a>
</p>


    			</footer>
    			







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




<link href='http://fonts.googleapis.com/css?family=Quattrocento+Sans|Roboto:400,300' rel='stylesheet' type='text/css'>


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26310657-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>




    		</div>
    	</section>
  	</div>
</body>
</html>
