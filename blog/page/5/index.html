
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Felipe Lima</title>
  <meta name="author" content="Felipe Lima">

  
  <meta name="description" content="Today my Firefox started behaving very strangely and extremely slow especially when using Gmail and Google Reader. I tried cleaning the cache, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://felipecsl.github.com/blog/page/5/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Felipe Lima" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26310657-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Felipe Lima</a></h1>
  
    <h2>weblog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:felipecsl.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/08/03/gmailgoogle-reader-unexplainably-slowunresponsive-in-firefox/">Gmail/Google Reader Unexplainably Slow/unresponsive in Firefox</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-08-03T04:16:00-07:00" pubdate data-updated="true">Aug 3<span>rd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today my Firefox started behaving very strangely and extremely slow especially when using Gmail and Google Reader. I tried cleaning the cache, restarting but nothing solved. Then, I realized I had installed Skype these days and it installed a Firefox add-on without even asking me for permission. I removed the add-on and Firefox went back to normal operation, fast and reliable, as always.</p>

<p>I have to say that Skype dissappointed me this time installing a defective add-on on my browser, since I don&rsquo;t even remember to have allowed it to do so.</p>

<p>Seems like I wasn&rsquo;t the only one who had this <a href="http://forum.skype.com/index.php?showtopic=86888">problem</a>. :(</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/07/27/dynamically-adding-user-controls-to-web-page-with-asp-net/">Dynamically Adding User Controls to Web Page With ASP.NET</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-27T04:09:00-07:00" pubdate data-updated="true">Jul 27<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been very busy lately and unfortunately didn&rsquo;t have enough time to stop here to write about things I have been working on. There are other subjects that I&rsquo;d like to talk about but, for now, I&rsquo;ll share my findings with asp.net user controls dynamically added to the page, difficulties, limitations and solutions.</p>

<p>I&rsquo;m working on a Ajax based web site that basically contains a content area in the right, where I need to put the dynamic content, based on the user selection on the left menu. The ongoing work can be seen <a href="/admin/Pages/www.felipel.com/visiocore/ContentPage.aspx">here</a>.</p>

<p>The easier way to do this is to create an asp.net UserControl for the content of each page and to dynamically add each control to the page based on the user selection. I also added an UpdateProgress panel for better user experience. However, here is where the problems start. First off, you cannot simply instantiate an asp.net UserControl through its constructor and add it to the page. That won&rsquo;t work. Instead, you&rsquo;ll need to use the factory method Page.LoadControl(), providing it the virtual path to your control so that it returns the instance for you. Eg.:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;Control c = &lt;span class="kwrd"&gt;this&lt;/span&gt;.LoadControl(&lt;span class="str"&gt;"~/MyUserControl.ascx"&lt;/span&gt;);   &lt;span class="rem"&gt;// Instantiate the user control&lt;/span&gt;






&lt;span class="lnum"&gt;   2:  &lt;/span&gt;&lt;span class="kwrd"&gt;this&lt;/span&gt;.ContentArea.Controls.Add(c);    // Add it to the placeholder
</code></pre>

<p>Here, we&rsquo;re instantiating the control and adding it to the page. So far, so good. But, what happens if your user control needs to execute some javascript function upon loading? Even if you explicitly put <script> tags in your user control markup, it won&rsquo;t be executed at this time, so the solution is to use RegisterStartupScript to execute the client code:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;ClientScript.RegisterStartupScript(&lt;span class="kwrd"&gt;typeof&lt;/span&gt;(&lt;span class="kwrd"&gt;this&lt;/span&gt;), &lt;span class="str"&gt;"some script key"&lt;/span&gt;, &lt;span class="str"&gt;"&lt;script type="&lt;/span&gt;text/javascript&lt;span class="str"&gt;"&gt;alert('hello world!');&lt;/script&gt;"&lt;/span&gt;);
</code></pre>

<p>or, if you&rsquo;re using Ajax, use the ScriptManager static method:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;ScriptManager.RegisterStartupScript(&lt;span class="kwrd"&gt;this&lt;/span&gt;, &lt;span class="kwrd"&gt;typeof&lt;/span&gt;(&lt;span class="kwrd"&gt;this&lt;/span&gt;), &lt;span class="str"&gt;"some script key"&lt;/span&gt;, &lt;span class="str"&gt;"&lt;script type="&lt;/span&gt;text/javascript&lt;span class="str"&gt;"&gt;alert('hello world!');&lt;/script&gt;"&lt;/span&gt;, &lt;span class="kwrd"&gt;false&lt;/span&gt;);
</code></pre>

<p>Put this and your user control will show up smoothly. If you don&rsquo;t like the fact that the screen may remain unresponsive for some time with Ajax, you can use UpdateProgress to show a &ldquo;Loading&rdquo; text, for example, while the content is being loaded. This is fairly easy. Check out this <a href="http://www.asp.net/learn/ajax-videos/video-123.aspx">video</a>  for further information.</p>

<p>Okay, so now, what happens if we need to fire an event inside the UserControl in response to a user click on an image, for example? Right, the click event will fire a page postback and then the event handling code will be fired in the code behind as expected. Right? Definitely no! Since our user controls are being added dynamically to the page, they will not be there anymore after the postback. This means that ASP.Net will not find the control and, therefore, no event will be fired.</p>

<p>Let me refresh some facts about ASP.Net postback functionality before continuing&hellip; Whenever you click a server control in the page, javascript <strong>doPostBack function is called (except for Button and ImageButton, that use a different method &ndash; form post). The </strong>doPostBack function takes two arguments, eventTarget and eventArgument. The eventTarget contains the ID of the control that causes the postback and the eventArgument contains any additional data associated with the control. Upon page reload, ASP.Net checks both Request.Params[&ldquo;<strong>EVENTTARGET&rdquo;] and Request.Params[&ldquo;</strong>EVENTARGUMENT&rdquo;] parameters for any postback data. If it finds it, it looks for the control ID and method specified in the <strong>EVENTTARGET var and calls the specified method, passing the </strong>EVENTARGUMENT value as a parameter.</p>

<p>Said that and knowing that our dynamic user control won&rsquo;t be present in the page during the postback, it is easy to conclude that ASP.Net won&rsquo;t find the control for the ID in the __EVENTTARGET parameter and, consequently, nothing will happen.</p>

<p>Okay, so we need to re-add our user control to the page during the postback, so that ASP.Net will be able to find it and fire its event handler. In order to accomplish that, we can use the page ViewState to store the name of the control currently in the page, so that we can re-add it in the page OnLoad event.</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;&lt;span class="kwrd"&gt;protected&lt;/span&gt; &lt;span class="kwrd"&gt;override&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; OnLoad(EventArgs e)






&lt;span class="lnum"&gt;   2:  &lt;/span&gt;{






&lt;span class="lnum"&gt;   3:  &lt;/span&gt;    &lt;span class="kwrd"&gt;base&lt;/span&gt;.OnLoad(e);






&lt;span class="lnum"&gt;   4:  &lt;/span&gt;






&lt;span class="lnum"&gt;   5:  &lt;/span&gt; 






&lt;span class="lnum"&gt;   6:  &lt;/span&gt;    &lt;span class="kwrd"&gt;if&lt;/span&gt; (!&lt;span class="kwrd"&gt;this&lt;/span&gt;.IsPostBack)






&lt;span class="lnum"&gt;   7:  &lt;/span&gt;    {






&lt;span class="lnum"&gt;   8:  &lt;/span&gt;        &lt;span class="rem"&gt;// If this is not a postback, set our the initial content page&lt;/span&gt;






&lt;span class="lnum"&gt;   9:  &lt;/span&gt;        ChangeSection(&lt;span class="str"&gt;"~/InitialControl.ascx"&lt;/span&gt;);






&lt;span class="lnum"&gt;  10:  &lt;/span&gt;    }






&lt;span class="lnum"&gt;  11:  &lt;/span&gt;    &lt;span class="kwrd"&gt;else&lt;/span&gt;






&lt;span class="lnum"&gt;  12:  &lt;/span&gt;    {






&lt;span class="lnum"&gt;  13:  &lt;/span&gt;        &lt;span class="rem"&gt;// Else, retrieve the CurrentControl value from the ViewState&lt;/span&gt;






&lt;span class="lnum"&gt;  14:  &lt;/span&gt;        &lt;span class="kwrd"&gt;string&lt;/span&gt; currentSection = ViewState[&lt;span class="str"&gt;"CurrentControl"&lt;/span&gt;] &lt;span class="kwrd"&gt;as&lt;/span&gt; &lt;span class="kwrd"&gt;string&lt;/span&gt;;






&lt;span class="lnum"&gt;  15:  &lt;/span&gt;        Control c = ChangeSection(currentSection);    &lt;span class="rem"&gt;// Use the control name to add it to the page&lt;/span&gt;






&lt;span class="lnum"&gt;  16:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  17:  &lt;/span&gt;        &lt;span class="kwrd"&gt;if&lt;/span&gt; (c &lt;span class="kwrd"&gt;is&lt;/span&gt; Eventos_EventosRealizados)






&lt;span class="lnum"&gt;  18:  &lt;/span&gt;        {






&lt;span class="lnum"&gt;  19:  &lt;/span&gt;            ((Eventos_EventosRealizados)c).UpdateCallback = delCallback;






&lt;span class="lnum"&gt;  20:  &lt;/span&gt;        }






&lt;span class="lnum"&gt;  21:  &lt;/span&gt;    }






&lt;span class="lnum"&gt;  22:  &lt;/span&gt;}






&lt;span class="lnum"&gt;  23:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  24:  &lt;/span&gt;&lt;span class="kwrd"&gt;public&lt;/span&gt; Control ChangeSection(&lt;span class="kwrd"&gt;string&lt;/span&gt; _sControl)






&lt;span class="lnum"&gt;  25:  &lt;/span&gt;{






&lt;span class="lnum"&gt;  26:  &lt;/span&gt;    Control c = &lt;span class="kwrd"&gt;this&lt;/span&gt;.LoadControl(_sControl);






&lt;span class="lnum"&gt;  27:  &lt;/span&gt;






&lt;span class="lnum"&gt;  28:  &lt;/span&gt;    &lt;span class="rem"&gt;// Put a 3 seconds delay so that we can see the magic happen -- remove in the final version&lt;/span&gt;






&lt;span class="lnum"&gt;  29:  &lt;/span&gt;    System.Threading.Thread.Sleep(3000);






&lt;span class="lnum"&gt;  30:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  31:  &lt;/span&gt;    &lt;span class="kwrd"&gt;this&lt;/span&gt;.ContentArea.Controls.Add(c);    &lt;span class="rem"&gt;// Add the control to the page&lt;/span&gt;






&lt;span class="lnum"&gt;  32:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  33:  &lt;/span&gt;    &lt;span class="rem"&gt;// Important: Set its ID or the event might not be fired,&lt;/span&gt;






&lt;span class="lnum"&gt;  34:  &lt;/span&gt;    &lt;span class="rem"&gt;// since ASP.Net uses the control ID to find it&lt;/span&gt;






&lt;span class="lnum"&gt;  35:  &lt;/span&gt;    c.ID = &lt;span class="str"&gt;"ContentUserControl"&lt;/span&gt;;






&lt;span class="lnum"&gt;  36:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  37:  &lt;/span&gt;    ViewState[&lt;span class="str"&gt;"CurrentControl"&lt;/span&gt;] = _sControl;  &lt;span class="rem"&gt;// store the control name in the ViewState&lt;/span&gt;






&lt;span class="lnum"&gt;  38:  &lt;/span&gt;






&lt;span class="lnum"&gt;  39:  &lt;/span&gt;    &lt;span class="rem"&gt;// Execute some javascript routine to refresh the screen (if needed)&lt;/span&gt;






&lt;span class="lnum"&gt;  40:  &lt;/span&gt;    ScriptManager.RegisterStartupScript(&lt;span class="kwrd"&gt;this&lt;/span&gt;, &lt;span class="kwrd"&gt;typeof&lt;/span&gt;(&lt;span class="kwrd"&gt;this&lt;/span&gt;), &lt;span class="str"&gt;"some script key"&lt;/span&gt;, &lt;span class="str"&gt;"&lt;script type="&lt;/span&gt;text/javascript&lt;span class="str"&gt;"&gt;refreshPage();&lt;/script&gt;"&lt;/span&gt;, &lt;span class="kwrd"&gt;false&lt;/span&gt;);






&lt;span class="lnum"&gt;  41:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  42:  &lt;/span&gt;    &lt;span class="kwrd"&gt;return&lt;/span&gt; c;






&lt;span class="lnum"&gt;  43:  &lt;/span&gt;}
</code></pre>

<p>So these are just some basic guidelines for handling user controls dynamically. If you need further info, <a href="http://asp.net">asp.net</a> official website is always a great place to start off and watch with some videos.</p>

<p>Till next time!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/07/14/about-jquery-intellisense-support-in-visual-studio/">About jQuery Intellisense Support in Visual Studio</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-14T15:46:00-07:00" pubdate data-updated="true">Jul 14<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I just found out that there is an effort at Microsoft together with the jQuery team in order to add intellisense support for this framework in Visual Studio 2008. We all know that the javascript intellisense support in VS has always been almost none, but now it seems that the guys at Microsoft are changing the way and starting to support it progressively, starting by including it in its ASP.NET MVC package and adding intellisense support for interaction with the AJAX framework.</p>

<p>I&rsquo;ve been trying to enable this functionality today and found out that it just isn&rsquo;t worth the effort, at least for the latest jQuery version (1.3.2). Basically, you need to first off <a href="http://weblogs.asp.net/scottgu/archive/2008/11/21/jquery-intellisense-in-vs-2008.aspx">install a patch</a> to enable the functionality. Then, you&rsquo;ll need a -vsdocs.js file, which is just an API descriptor containing all the documentation for the framework. It is not actually a js file. You can find more detailed information <a href="http://blogs.ipona.com/james/archive/2009/01/14/jquery-1.3-and-visual-studio-2008-intellisense.aspx">here</a>. Then, JScript IntelliSense will parse all the included js files and check for errors. If it thinks that one of your included script files isn&rsquo;t good, intellisense just won&rsquo;t work. The problem is that it complains about the actual jQuery file not being well formed:</p>

<p><strong>&ldquo;Warning</strong><strong>  </strong><strong>15</strong><strong>  </strong><strong>Error updating JScript IntelliSense: C:.&hellip;\javascript\jquery-1.3.js: Object doesn&rsquo;t support this property or method @ 2069:1&rdquo;</strong></p>

<p>Just to shorten the story, you&rsquo;ll get to spend some time trying to make it to work, probably without success and then will give up miserably (my case). The fact is that it just isn&rsquo;t worth all the work, while you still have a <a href="http://docs.jquery.com/Main_Page">decent online documentation</a> to help.</p>

<p>In the end, you&rsquo;ll have to calm down and wait a little bit while Visual Studio 2010 is still beta since jQuery will be shipped with VS2010 and it will include built-in robust intellisense and documentation (not from a downloaded patch). This is good news for us all! In the meantime, let&rsquo;s wait for the final release :)</p>

<p>[Update 07/17/2009]</p>

<p>Just ran into a great post about this exactly same subject at <a href="http://www.learningjquery.com/2009/07/setting-up-visual-studio-intellisense-for-jquery#more-822">learninjquery.com</a> which was an eye-opener to me. It is actually very simple to make it work if you know exactly what has to be done. And what has to be done is just to add the /// reference comment to the start of your javascript file and everything works seamlessly. No need to include the -vsdocs in the actual html file at all! Of course that if you have different scenarios like custom controls, dynamically generated javascript, etc., this may become painful again, but for the regular usage, this post at learningjquery.com will set you will all that is needed to be ready to go in minutes.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/07/08/automatically-tracking-last-modification-datetime-in-table-column/">Automatically Tracking Last Modification Date/time in Table Column</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-08T02:55:00-07:00" pubdate data-updated="true">Jul 8<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Lately I found a very simple and yet consistent way to track the last update made to a Sql Server database table. You can easily store the modification date and time through a table trigger that can set a specific column of the updated row(s) with the GETDATE() function.</p>

<p>In order to do that, create a new trigger for your table and use the <strong>Inserted</strong> virtual table to obtain the ID of the entry, in order to update it. We&rsquo;ll use here a <strong>LastModified </strong>column, which will store a datetime:</p>

<p>CREATE TRIGGER last_modification_timestamp</p>

<p>ON target_table</p>

<p>AFTER INSERT, UPDATE</p>

<p>AS</p>

<p>DECLARE @colID INT</p>

<p>SELECT @colID = (SELECT ID FROM Inserted)</p>

<p>UPDATE target_table SET LastModified = GETDATE() WHERE ID = @colID</p>

<p>So, we&rsquo;re basically retrieving the column ID (primary key) from the affected row and using it to update the LastModified column with the current date and time.</p>

<p>This way, you can enforce this policy and guarantee that you&rsquo;ll always get the correct date/time in that column, since the trigger will be automatically executed just after each INSERT and DELETE.</p>

<p>Hope this helps!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/07/02/ef-objectcontext-attach-and-objectstatemanager/">EF ObjectContext.Attach and ObjectStateManager</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-02T00:30:00-07:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When working with the Entity Framework, you&rsquo;ve got to be extremely careful when exchanging Entities between different ObjectContexts. You probably know that if you want to modify an Entity which is already added to the database, you have to first attach it to the context before modifying it, so that EF can keep track of the changes you made to that instance and save them to the database later. There is a good reference page at msdn about <a href="http://msdn.microsoft.com/en-us/library/bb896271.aspx">attaching related objects</a>.</p>

<p>Attach assumes your Entity has not been changed while it was not being tracked by the ObjectContext. Otherwise, call <strong>ApplyPropertyChanges</strong> to attach and apply the changes.</p>

<p>Yesterday, I lost almost my entire day trying to translate this exception I was getting in ObjectContext.Attach():</p>

<p>&ldquo;<strong>System.InvalidOperationException : An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key.</strong>&rdquo;</p>

<p>EF complains that the Entity you&rsquo;re trying to add actually has an EntityKey identical to one that is already in the database. Okay, this seems obvious to me, since this is the actual purpose of Attach &ndash; start tracking changes objects that already exist in the database.</p>

<p>After an entire afternoon searching for an answer, I came accross some pages with other issues related to Attach that some people had, as well some solutions for <a href="http://www.codeproject.com/KB/architecture/attachobjectgraph.aspx">them</a>.</p>

<p>Today I re-read the exception message and the answer just popped on my face: &ldquo;<strong>I&rsquo;m already tracking the object you&rsquo;re trying to Attach, dumbass!</strong>&rdquo;. In fact, you cannot Attach an object to an ObjectContext if that object somehow has been already cached by the ObjectStateManager.</p>

<p>Let me exemplify:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;&lt;span class="kwrd"&gt;public&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; UpdateUserBooks(User _user)






&lt;span class="lnum"&gt;   2:  &lt;/span&gt;{






&lt;span class="lnum"&gt;   3:  &lt;/span&gt;    &lt;span class="kwrd"&gt;using&lt;/span&gt; (DataEntities db = &lt;span class="kwrd"&gt;new&lt;/span&gt; DataEntities())






&lt;span class="lnum"&gt;   4:  &lt;/span&gt;    {






&lt;span class="lnum"&gt;   5:  &lt;/span&gt;        Book userBook = (from b &lt;span class="kwrd"&gt;in&lt;/span&gt; db.Book.Include(&lt;span class="str"&gt;"Users"&lt;/span&gt;)






&lt;span class="lnum"&gt;   6:  &lt;/span&gt;                        select b).FirstOrDefault();






&lt;span class="lnum"&gt;   7:  &lt;/span&gt;






&lt;span class="lnum"&gt;   8:  &lt;/span&gt;        db.Attach(_user);    &lt;span class="rem"&gt;// throws InvalidOperationException&lt;/span&gt;






&lt;span class="lnum"&gt;   9:  &lt;/span&gt;        userBook.Users.Add(_user);






&lt;span class="lnum"&gt;  10:  &lt;/span&gt;        db.SaveChanges();






&lt;span class="lnum"&gt;  11:  &lt;/span&gt;    }






&lt;span class="lnum"&gt;  12:  &lt;/span&gt;}
</code></pre>

<p>What is happening? Your userBook query returns all the Books from the database <strong>AND</strong> their related Users (the Include was there for a reason). When you try to attach your User after_user after the query has been run, the ObjectContext already has _user under its hood, so trying to Attach it will throw an InvalidOperationException.</p>

<p>The solution is very simple: Always attach all your Entities before doing any operation/query in your ObjectContext. This way, you avoid any double-tracking request. If the ObjectContext needs your Entity later, it will retrieve the instance you attached before and you&rsquo;re good to go! Follow the fixed code:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;&lt;span class="kwrd"&gt;public&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; UpdateUserBooks(User _user)






&lt;span class="lnum"&gt;   2:  &lt;/span&gt;{






&lt;span class="lnum"&gt;   3:  &lt;/span&gt;    &lt;span class="kwrd"&gt;using&lt;/span&gt; (DataEntities db = &lt;span class="kwrd"&gt;new&lt;/span&gt; DataEntities())






&lt;span class="lnum"&gt;   4:  &lt;/span&gt;    {






&lt;span class="lnum"&gt;   5:  &lt;/span&gt;        db.Attach(_user);    &lt;span class="rem"&gt;// works fine!&lt;/span&gt;






&lt;span class="lnum"&gt;   6:  &lt;/span&gt;






&lt;span class="lnum"&gt;   7:  &lt;/span&gt;        Book userBook = (from b &lt;span class="kwrd"&gt;in&lt;/span&gt; db.Book.Include(&lt;span class="str"&gt;"Users"&lt;/span&gt;)






&lt;span class="lnum"&gt;   8:  &lt;/span&gt;                        select b).FirstOrDefault();






&lt;span class="lnum"&gt;   9:  &lt;/span&gt;






&lt;span class="lnum"&gt;  10:  &lt;/span&gt;        userBook.Users.Add(_user);






&lt;span class="lnum"&gt;  11:  &lt;/span&gt;        db.SaveChanges();






&lt;span class="lnum"&gt;  12:  &lt;/span&gt;    }






&lt;span class="lnum"&gt;  13:  &lt;/span&gt;}
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/24/notimplementedexception-in-graphics-drawimage/">NotImplementedException in Graphics.DrawImage</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-24T04:13:00-07:00" pubdate data-updated="true">Jun 24<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It is a bit weird to notice that a .Net Framework method returns NotImplementedException. At least it was for me, mainly because it is not documented anywhere in the msdn documentation.</p>

<p>It turns out that Graphics.DrawImage throws this exception when an Image object is passed in. This is really funny, since this method actually expects an Image object as its first argument, so my first-try code to print an image file was:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;&lt;span class="kwrd"&gt;public&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; PrintImage(&lt;span class="kwrd"&gt;string&lt;/span&gt; fileName)






&lt;span class="lnum"&gt;   2:  &lt;/span&gt; 






&lt;span class="lnum"&gt;   3:  &lt;/span&gt;{






&lt;span class="lnum"&gt;   4:  &lt;/span&gt; 






&lt;span class="lnum"&gt;   5:  &lt;/span&gt;      Image img = Image.FromFile(fileName);






&lt;span class="lnum"&gt;   6:  &lt;/span&gt;      PrintDocument printDoc = &lt;span class="kwrd"&gt;new&lt;/span&gt; PrintDocument();






&lt;span class="lnum"&gt;   7:  &lt;/span&gt;      printDoc.DocumentName = &lt;span class="kwrd"&gt;this&lt;/span&gt;.m_sFilename;






&lt;span class="lnum"&gt;   8:  &lt;/span&gt;      printDoc.PrintPage += &lt;span class="kwrd"&gt;new&lt;/span&gt; PrintPageEventHandler(PrintPage);






&lt;span class="lnum"&gt;   9:  &lt;/span&gt;      printDoc.Print();






&lt;span class="lnum"&gt;  10:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  11:  &lt;/span&gt;}






&lt;span class="lnum"&gt;  12:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  13:  &lt;/span&gt;&lt;span class="kwrd"&gt;private&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; PrintPage(&lt;span class="kwrd"&gt;object&lt;/span&gt; sender, PrintPageEventArgs e)






&lt;span class="lnum"&gt;  14:  &lt;/span&gt;{






&lt;span class="lnum"&gt;  15:  &lt;/span&gt;      &lt;span class="rem"&gt;// Throws NotImplementedException!!!&lt;/span&gt;






&lt;span class="lnum"&gt;  16:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  17:  &lt;/span&gt;      e.Graphics.DrawImage(






&lt;span class="lnum"&gt;  18:  &lt;/span&gt;           &lt;span class="kwrd"&gt;this&lt;/span&gt;.printedImage,






&lt;span class="lnum"&gt;  19:  &lt;/span&gt;           &lt;span class="kwrd"&gt;new&lt;/span&gt; Point(e.MarginBounds.Left, e.MarginBounds.Top));






&lt;span class="lnum"&gt;  20:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  21:  &lt;/span&gt;      e.HasMorePages = &lt;span class="kwrd"&gt;false&lt;/span&gt;;






&lt;span class="lnum"&gt;  22:  &lt;/span&gt;}
</code></pre>

<p>Weird, eh?! So, the solution?</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;Bitmap img = (Bitmap)Image.FromFile(fileName);
</code></pre>

<p>Bitmap class extends Image, so, IMHO, DrawImage should determine in runtime that the image passed in is actually is a Bitmap and do whatever it has to do, but, strangely, it complains and throws a NotImplementedException for the exactly same runtime object.</p>

<p>Can someone explain what is happening here?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/17/hiding-sensitive-data-in-the-query-string/">Hiding Sensitive Data in the Query String</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-17T09:23:00-07:00" pubdate data-updated="true">Jun 17<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes you need to pass data to a web page and at the same time you need to be able to provide a permalink to that URL to the user. In this case, you don&rsquo;t have any option other than passing those parameters through the Query String. Otherwise, you could use the Form, Session state, database or any other persistence or data transport mechanism.</p>

<p>I recently had to create a page that needed to receive some sensitive parameters and, at the same time, I needed to be able to provide the URL to the user, so that he/she could view that same page. However, I needed to somehow make the parameters private to the system, so that no one could decypher what data the actual parameters held. The only solution I found was to <a href="http://en.wikipedia.org/wiki/Cryptography">encrypt</a> the Query String values!</p>

<p>For those who are not very familiar with the subject (like me), cryptography can be a really scary thing! Thankfully, Jeff Atwood, founder of the famous <a href="/admin/Pages/www.codinghorror.com">codinghorror.com</a> blog (which of I am a fan also!) wrote a great <a href="http://www.codeproject.com/KB/security/SimpleEncryption.aspx">article</a> at Code Project with some simple background, definitions and a .NET code for those who do not have a strong background on the subject.</p>

<p>I not only found that very useful but also ported the code to C# to fulfill my needs. <a href="http://www.developerfusion.com/tools/convert/vb-to-csharp/">This tool</a> helped me with the rough conversion but I still had to do some conversion by hand, since the code did not compile at first try.</p>

<p>I separated the code logically in different files for better reading. It can be downloaded <a href="http://www.felipel.com/files/Encryption.zip">here</a>.</p>

<p>Below is a simple usage of the Simmetric-key class with the Rijndael (<a href="http://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a>) provider to encrypt the query string variable in one page, send it, and then decrypt in the other side:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;Symmetric symEncryption = &lt;span class="kwrd"&gt;new&lt;/span&gt; Symmetric(Symmetric.Provider.Rijndael);

&lt;span class="lnum"&gt;   2:  &lt;/span&gt;symEncryption.Key.Text = &lt;span class="str"&gt;"SomeKey"&lt;/span&gt;;

&lt;span class="lnum"&gt;   3:  &lt;/span&gt; 

&lt;span class="lnum"&gt;   4:  &lt;/span&gt;&lt;span class="kwrd"&gt;string&lt;/span&gt; sSensitiveText = &lt;span class="str"&gt;"Some sensitive data"&lt;/span&gt;;

&lt;span class="lnum"&gt;   5:  &lt;/span&gt;&lt;span class="kwrd"&gt;string&lt;/span&gt; sEncryptedData = symEncryption.Encrypt(&lt;span class="kwrd"&gt;new&lt;/span&gt; Data(sSensitiveText)).Base64;

&lt;span class="lnum"&gt;   6:  &lt;/span&gt; 

&lt;span class="lnum"&gt;   7:  &lt;/span&gt;&lt;span class="rem"&gt;// fearlessly send sEncryptedData in your query string&lt;/span&gt;

&lt;span class="lnum"&gt;   8:  &lt;/span&gt;Response.Redirect(

&lt;span class="str"&gt;&lt;span style="white-space: pre" class="Apple-tab-span"&gt;    &lt;/span&gt;"http://www.someurl.com/somepage.aspx?data="&lt;/span&gt; + Server.UrlEncode(sEncryptedData));

&lt;span class="lnum"&gt;   9:  &lt;/span&gt; 

&lt;span class="lnum"&gt;  10:  &lt;/span&gt;...

&lt;span class="lnum"&gt;  11:  &lt;/span&gt; 

&lt;span class="lnum"&gt;  12:  &lt;/span&gt;&lt;span class="rem"&gt;// in the other side, decrypt the text you just received&lt;/span&gt;

&lt;span class="lnum"&gt;  13:  &lt;/span&gt;&lt;span class="kwrd"&gt;string&lt;/span&gt; sDecryptedText = symEncryption.Decrypt(

&lt;span class="kwrd"&gt;&lt;span style="white-space: pre" class="Apple-tab-span"&gt;   &lt;/span&gt;new&lt;/span&gt; Data(Request.QueryString[&lt;span class="str"&gt;"data"&lt;/span&gt;].FromBase64())).Text;

&lt;span class="lnum"&gt;  14:  &lt;/span&gt; 

&lt;span class="lnum"&gt;  15:  &lt;/span&gt;&lt;span class="rem"&gt;// outputs "Some sensitive data"&lt;/span&gt;

&lt;span class="lnum"&gt;  16:  &lt;/span&gt;Console.WriteLine(sDecryptedText); 
</code></pre>

<p>Hope this helps someone :)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/16/passing-variables-to-sql-server-script/">Passing Variables to Sql Server Script</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-16T05:44:00-07:00" pubdate data-updated="true">Jun 16<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here is something I found out today that might be useful for Sql Server users out there:</p>

<p>If you need to pass a variable to a sql script file in runtime, you can use the <strong>sqlcmd</strong> tool with the <strong>-v option</strong>, for example:</p>

<p>[code:c#]</p>

<p>sqlcmd -S localhost\SQLEXPRESS -i myscript.sql -v myVar1=&ldquo;myVar1Value&rdquo; myVar2=&ldquo;myVar2Value&rdquo;</p>

<p>[/code]</p>

<p>Then, inside the sql script, those variables can be accessed using the $(var) format:</p>

<p>[code:c#]</p>

<p>ALTER TABLE [dbo].[$(myVar1)] INSERT &hellip; VALUES ($(myVar2), $(myVar3) &hellip;)</p>

<p>[/code]</p>

<p>You can also specify these vars inside the sql script with <strong>setvar</strong>. More information in <a href="http://msdn.microsoft.com/en-us/library/ms188714.aspx">this MSDN article (Using sqlcmd with Scripting Variables).</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/10/nunit-framework-assembly-not-found/">nunit.framework Assembly Not Found</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-10T04:03:00-07:00" pubdate data-updated="true">Jun 10<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I ran into a FileNotFoundException lately when working with the latest NUnit release 2.5. It seems like its assemblies are not being added to the .Net Framework GAC (Global Assembly Cache), so this means that, unless you manually copy them to the same directory as you&rsquo;re working on, you&rsquo;ll have to manually add them to the GAC.</p>

<p>There is a well explained reply in <a href="http://stackoverflow.com/questions/176850/nunit-assembly-not-found">StackOverflow</a> (again) telling how to use the &ldquo;gacutil&rdquo; to solve this. Basically all you have to do is unregister all your old versions of NUnit (if any) and then use gacutil /i to register the assemblies.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/09/serializing-anonymous-types-in-net/">Serializing Anonymous Types in .Net</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-09T00:56:00-07:00" pubdate data-updated="true">Jun 9<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In C#, you are not able to serialize an object that does not have a parameterless constructor. At least, XmlSerializer is not able to do this. It seems like BinaryFormatter is able, as per this <a href="http://stackoverflow.com/questions/267724/why-serializable-class-need-a-parameterless-constructor">StackOverflow question</a>.</p>

<p>This means you are not able to Xml serialize some object like this, also:</p>

<p>[code:c#]</p>

<p>var myObj = new</p>

<p>{</p>

<p>MyPropertyString = &ldquo;prop1value&rdquo;,</p>

<p>MyPropertyInt = 2,</p>

<p>MyPropertyList = new List<string> { &ldquo;bananas&rdquo;, &ldquo;apples&rdquo;, &ldquo;pees&rdquo; }</p>

<p>});</p>

<p>[/code]</p>

<p>I needed to be able to serialize this kind of object to database in a human-readable format so, if you don&rsquo;t need to output in Xml format specifically, you can try this great <a href="http://james.newtonking.com/projects/json-net.aspx">Json.NET library</a> by James Newton-King, that worked smoothly for me, as easy as:</p>

<p>[code:c#]</p>

<p>string jsonString = JsonConvert.SerializeObject(_myObj);</p>

<p>[/code]</p>

<p>Surely you can do many other things with this library, which you can find out by yourself.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/6/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/4/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/12/06/publishing-an-android-library-to-maven-central/">Publishing an Android Library to Maven Central with Gradle</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/12/building-a-custom-view-with-android/">Building a Custom View with Android</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/20/animated-gifs-with-android/">Handling Animated GIFs with Android the right way</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/31/starting-with-android-managing-images/">Starting with Android - managing images</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/31/when-two-identical-strings-are-different/">When two identical strings are different?</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/felipecsl">@felipecsl</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'felipecsl',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<a href="mailto:felipe.lima@gmail.com" title="Pair program with me!">
  <img  src="http://pairprogramwith.me/badge.png"
        alt="Pair program with me!" style="width: 150px" />
</a>
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Felipe Lima -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
