
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Felipe Lima</title>
  <meta name="author" content="Felipe Lima">

  
  <meta name="description" content="Lately I found a very simple and yet consistent way to track the last update made to a Sql Server database table. You can easily store the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://felipecsl.github.com/blog/page/5/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Felipe Lima" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26310657-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Felipe Lima</a></h1>
  
    <h2>weblog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:felipecsl.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/07/08/automatically-tracking-last-modification-datetime-in-table-column/">Automatically Tracking Last Modification Date/time in Table Column</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-08T02:55:00-07:00" pubdate data-updated="true">Jul 8<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Lately I found a very simple and yet consistent way to track the last update made to a Sql Server database table. You can easily store the modification date and time through a table trigger that can set a specific column of the updated row(s) with the GETDATE() function.</p>

<p>In order to do that, create a new trigger for your table and use the <strong>Inserted</strong> virtual table to obtain the ID of the entry, in order to update it. We&rsquo;ll use here a <strong>LastModified </strong>column, which will store a datetime:</p>

<p>CREATE TRIGGER last_modification_timestamp</p>

<p>ON target_table</p>

<p>AFTER INSERT, UPDATE</p>

<p>AS</p>

<p>DECLARE @colID INT</p>

<p>SELECT @colID = (SELECT ID FROM Inserted)</p>

<p>UPDATE target_table SET LastModified = GETDATE() WHERE ID = @colID</p>

<p>So, we&rsquo;re basically retrieving the column ID (primary key) from the affected row and using it to update the LastModified column with the current date and time.</p>

<p>This way, you can enforce this policy and guarantee that you&rsquo;ll always get the correct date/time in that column, since the trigger will be automatically executed just after each INSERT and DELETE.</p>

<p>Hope this helps!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/07/02/ef-objectcontext-attach-and-objectstatemanager/">EF ObjectContext.Attach and ObjectStateManager</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-02T00:30:00-07:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When working with the Entity Framework, you&rsquo;ve got to be extremely careful when exchanging Entities between different ObjectContexts. You probably know that if you want to modify an Entity which is already added to the database, you have to first attach it to the context before modifying it, so that EF can keep track of the changes you made to that instance and save them to the database later. There is a good reference page at msdn about <a href="http://msdn.microsoft.com/en-us/library/bb896271.aspx">attaching related objects</a>.</p>

<p>Attach assumes your Entity has not been changed while it was not being tracked by the ObjectContext. Otherwise, call <strong>ApplyPropertyChanges</strong> to attach and apply the changes.</p>

<p>Yesterday, I lost almost my entire day trying to translate this exception I was getting in ObjectContext.Attach():</p>

<p>&ldquo;<strong>System.InvalidOperationException : An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key.</strong>&rdquo;</p>

<p>EF complains that the Entity you&rsquo;re trying to add actually has an EntityKey identical to one that is already in the database. Okay, this seems obvious to me, since this is the actual purpose of Attach &ndash; start tracking changes objects that already exist in the database.</p>

<p>After an entire afternoon searching for an answer, I came accross some pages with other issues related to Attach that some people had, as well some solutions for <a href="http://www.codeproject.com/KB/architecture/attachobjectgraph.aspx">them</a>.</p>

<p>Today I re-read the exception message and the answer just popped on my face: &ldquo;<strong>I&rsquo;m already tracking the object you&rsquo;re trying to Attach, dumbass!</strong>&rdquo;. In fact, you cannot Attach an object to an ObjectContext if that object somehow has been already cached by the ObjectStateManager.</p>

<p>Let me exemplify:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;&lt;span class="kwrd"&gt;public&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; UpdateUserBooks(User _user)






&lt;span class="lnum"&gt;   2:  &lt;/span&gt;{






&lt;span class="lnum"&gt;   3:  &lt;/span&gt;    &lt;span class="kwrd"&gt;using&lt;/span&gt; (DataEntities db = &lt;span class="kwrd"&gt;new&lt;/span&gt; DataEntities())






&lt;span class="lnum"&gt;   4:  &lt;/span&gt;    {






&lt;span class="lnum"&gt;   5:  &lt;/span&gt;        Book userBook = (from b &lt;span class="kwrd"&gt;in&lt;/span&gt; db.Book.Include(&lt;span class="str"&gt;"Users"&lt;/span&gt;)






&lt;span class="lnum"&gt;   6:  &lt;/span&gt;                        select b).FirstOrDefault();






&lt;span class="lnum"&gt;   7:  &lt;/span&gt;






&lt;span class="lnum"&gt;   8:  &lt;/span&gt;        db.Attach(_user);    &lt;span class="rem"&gt;// throws InvalidOperationException&lt;/span&gt;






&lt;span class="lnum"&gt;   9:  &lt;/span&gt;        userBook.Users.Add(_user);






&lt;span class="lnum"&gt;  10:  &lt;/span&gt;        db.SaveChanges();






&lt;span class="lnum"&gt;  11:  &lt;/span&gt;    }






&lt;span class="lnum"&gt;  12:  &lt;/span&gt;}
</code></pre>

<p>What is happening? Your userBook query returns all the Books from the database <strong>AND</strong> their related Users (the Include was there for a reason). When you try to attach your User after_user after the query has been run, the ObjectContext already has _user under its hood, so trying to Attach it will throw an InvalidOperationException.</p>

<p>The solution is very simple: Always attach all your Entities before doing any operation/query in your ObjectContext. This way, you avoid any double-tracking request. If the ObjectContext needs your Entity later, it will retrieve the instance you attached before and you&rsquo;re good to go! Follow the fixed code:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;&lt;span class="kwrd"&gt;public&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; UpdateUserBooks(User _user)






&lt;span class="lnum"&gt;   2:  &lt;/span&gt;{






&lt;span class="lnum"&gt;   3:  &lt;/span&gt;    &lt;span class="kwrd"&gt;using&lt;/span&gt; (DataEntities db = &lt;span class="kwrd"&gt;new&lt;/span&gt; DataEntities())






&lt;span class="lnum"&gt;   4:  &lt;/span&gt;    {






&lt;span class="lnum"&gt;   5:  &lt;/span&gt;        db.Attach(_user);    &lt;span class="rem"&gt;// works fine!&lt;/span&gt;






&lt;span class="lnum"&gt;   6:  &lt;/span&gt;






&lt;span class="lnum"&gt;   7:  &lt;/span&gt;        Book userBook = (from b &lt;span class="kwrd"&gt;in&lt;/span&gt; db.Book.Include(&lt;span class="str"&gt;"Users"&lt;/span&gt;)






&lt;span class="lnum"&gt;   8:  &lt;/span&gt;                        select b).FirstOrDefault();






&lt;span class="lnum"&gt;   9:  &lt;/span&gt;






&lt;span class="lnum"&gt;  10:  &lt;/span&gt;        userBook.Users.Add(_user);






&lt;span class="lnum"&gt;  11:  &lt;/span&gt;        db.SaveChanges();






&lt;span class="lnum"&gt;  12:  &lt;/span&gt;    }






&lt;span class="lnum"&gt;  13:  &lt;/span&gt;}
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/24/notimplementedexception-in-graphics-drawimage/">NotImplementedException in Graphics.DrawImage</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-24T04:13:00-07:00" pubdate data-updated="true">Jun 24<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It is a bit weird to notice that a .Net Framework method returns NotImplementedException. At least it was for me, mainly because it is not documented anywhere in the msdn documentation.</p>

<p>It turns out that Graphics.DrawImage throws this exception when an Image object is passed in. This is really funny, since this method actually expects an Image object as its first argument, so my first-try code to print an image file was:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;&lt;span class="kwrd"&gt;public&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; PrintImage(&lt;span class="kwrd"&gt;string&lt;/span&gt; fileName)






&lt;span class="lnum"&gt;   2:  &lt;/span&gt; 






&lt;span class="lnum"&gt;   3:  &lt;/span&gt;{






&lt;span class="lnum"&gt;   4:  &lt;/span&gt; 






&lt;span class="lnum"&gt;   5:  &lt;/span&gt;      Image img = Image.FromFile(fileName);






&lt;span class="lnum"&gt;   6:  &lt;/span&gt;      PrintDocument printDoc = &lt;span class="kwrd"&gt;new&lt;/span&gt; PrintDocument();






&lt;span class="lnum"&gt;   7:  &lt;/span&gt;      printDoc.DocumentName = &lt;span class="kwrd"&gt;this&lt;/span&gt;.m_sFilename;






&lt;span class="lnum"&gt;   8:  &lt;/span&gt;      printDoc.PrintPage += &lt;span class="kwrd"&gt;new&lt;/span&gt; PrintPageEventHandler(PrintPage);






&lt;span class="lnum"&gt;   9:  &lt;/span&gt;      printDoc.Print();






&lt;span class="lnum"&gt;  10:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  11:  &lt;/span&gt;}






&lt;span class="lnum"&gt;  12:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  13:  &lt;/span&gt;&lt;span class="kwrd"&gt;private&lt;/span&gt; &lt;span class="kwrd"&gt;void&lt;/span&gt; PrintPage(&lt;span class="kwrd"&gt;object&lt;/span&gt; sender, PrintPageEventArgs e)






&lt;span class="lnum"&gt;  14:  &lt;/span&gt;{






&lt;span class="lnum"&gt;  15:  &lt;/span&gt;      &lt;span class="rem"&gt;// Throws NotImplementedException!!!&lt;/span&gt;






&lt;span class="lnum"&gt;  16:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  17:  &lt;/span&gt;      e.Graphics.DrawImage(






&lt;span class="lnum"&gt;  18:  &lt;/span&gt;           &lt;span class="kwrd"&gt;this&lt;/span&gt;.printedImage,






&lt;span class="lnum"&gt;  19:  &lt;/span&gt;           &lt;span class="kwrd"&gt;new&lt;/span&gt; Point(e.MarginBounds.Left, e.MarginBounds.Top));






&lt;span class="lnum"&gt;  20:  &lt;/span&gt; 






&lt;span class="lnum"&gt;  21:  &lt;/span&gt;      e.HasMorePages = &lt;span class="kwrd"&gt;false&lt;/span&gt;;






&lt;span class="lnum"&gt;  22:  &lt;/span&gt;}
</code></pre>

<p>Weird, eh?! So, the solution?</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;Bitmap img = (Bitmap)Image.FromFile(fileName);
</code></pre>

<p>Bitmap class extends Image, so, IMHO, DrawImage should determine in runtime that the image passed in is actually is a Bitmap and do whatever it has to do, but, strangely, it complains and throws a NotImplementedException for the exactly same runtime object.</p>

<p>Can someone explain what is happening here?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/17/hiding-sensitive-data-in-the-query-string/">Hiding Sensitive Data in the Query String</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-17T09:23:00-07:00" pubdate data-updated="true">Jun 17<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes you need to pass data to a web page and at the same time you need to be able to provide a permalink to that URL to the user. In this case, you don&rsquo;t have any option other than passing those parameters through the Query String. Otherwise, you could use the Form, Session state, database or any other persistence or data transport mechanism.</p>

<p>I recently had to create a page that needed to receive some sensitive parameters and, at the same time, I needed to be able to provide the URL to the user, so that he/she could view that same page. However, I needed to somehow make the parameters private to the system, so that no one could decypher what data the actual parameters held. The only solution I found was to <a href="http://en.wikipedia.org/wiki/Cryptography">encrypt</a> the Query String values!</p>

<p>For those who are not very familiar with the subject (like me), cryptography can be a really scary thing! Thankfully, Jeff Atwood, founder of the famous <a href="/admin/Pages/www.codinghorror.com">codinghorror.com</a> blog (which of I am a fan also!) wrote a great <a href="http://www.codeproject.com/KB/security/SimpleEncryption.aspx">article</a> at Code Project with some simple background, definitions and a .NET code for those who do not have a strong background on the subject.</p>

<p>I not only found that very useful but also ported the code to C# to fulfill my needs. <a href="http://www.developerfusion.com/tools/convert/vb-to-csharp/">This tool</a> helped me with the rough conversion but I still had to do some conversion by hand, since the code did not compile at first try.</p>

<p>I separated the code logically in different files for better reading. It can be downloaded <a href="http://www.felipel.com/files/Encryption.zip">here</a>.</p>

<p>Below is a simple usage of the Simmetric-key class with the Rijndael (<a href="http://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a>) provider to encrypt the query string variable in one page, send it, and then decrypt in the other side:</p>

<pre><code>&lt;span class="lnum"&gt;   1:  &lt;/span&gt;Symmetric symEncryption = &lt;span class="kwrd"&gt;new&lt;/span&gt; Symmetric(Symmetric.Provider.Rijndael);

&lt;span class="lnum"&gt;   2:  &lt;/span&gt;symEncryption.Key.Text = &lt;span class="str"&gt;"SomeKey"&lt;/span&gt;;

&lt;span class="lnum"&gt;   3:  &lt;/span&gt; 

&lt;span class="lnum"&gt;   4:  &lt;/span&gt;&lt;span class="kwrd"&gt;string&lt;/span&gt; sSensitiveText = &lt;span class="str"&gt;"Some sensitive data"&lt;/span&gt;;

&lt;span class="lnum"&gt;   5:  &lt;/span&gt;&lt;span class="kwrd"&gt;string&lt;/span&gt; sEncryptedData = symEncryption.Encrypt(&lt;span class="kwrd"&gt;new&lt;/span&gt; Data(sSensitiveText)).Base64;

&lt;span class="lnum"&gt;   6:  &lt;/span&gt; 

&lt;span class="lnum"&gt;   7:  &lt;/span&gt;&lt;span class="rem"&gt;// fearlessly send sEncryptedData in your query string&lt;/span&gt;

&lt;span class="lnum"&gt;   8:  &lt;/span&gt;Response.Redirect(

&lt;span class="str"&gt;&lt;span style="white-space: pre" class="Apple-tab-span"&gt;    &lt;/span&gt;"http://www.someurl.com/somepage.aspx?data="&lt;/span&gt; + Server.UrlEncode(sEncryptedData));

&lt;span class="lnum"&gt;   9:  &lt;/span&gt; 

&lt;span class="lnum"&gt;  10:  &lt;/span&gt;...

&lt;span class="lnum"&gt;  11:  &lt;/span&gt; 

&lt;span class="lnum"&gt;  12:  &lt;/span&gt;&lt;span class="rem"&gt;// in the other side, decrypt the text you just received&lt;/span&gt;

&lt;span class="lnum"&gt;  13:  &lt;/span&gt;&lt;span class="kwrd"&gt;string&lt;/span&gt; sDecryptedText = symEncryption.Decrypt(

&lt;span class="kwrd"&gt;&lt;span style="white-space: pre" class="Apple-tab-span"&gt;   &lt;/span&gt;new&lt;/span&gt; Data(Request.QueryString[&lt;span class="str"&gt;"data"&lt;/span&gt;].FromBase64())).Text;

&lt;span class="lnum"&gt;  14:  &lt;/span&gt; 

&lt;span class="lnum"&gt;  15:  &lt;/span&gt;&lt;span class="rem"&gt;// outputs "Some sensitive data"&lt;/span&gt;

&lt;span class="lnum"&gt;  16:  &lt;/span&gt;Console.WriteLine(sDecryptedText); 
</code></pre>

<p>Hope this helps someone :)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/16/passing-variables-to-sql-server-script/">Passing Variables to Sql Server Script</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-16T05:44:00-07:00" pubdate data-updated="true">Jun 16<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here is something I found out today that might be useful for Sql Server users out there:</p>

<p>If you need to pass a variable to a sql script file in runtime, you can use the <strong>sqlcmd</strong> tool with the <strong>-v option</strong>, for example:</p>

<p>[code:c#]</p>

<p>sqlcmd -S localhost\SQLEXPRESS -i myscript.sql -v myVar1=&ldquo;myVar1Value&rdquo; myVar2=&ldquo;myVar2Value&rdquo;</p>

<p>[/code]</p>

<p>Then, inside the sql script, those variables can be accessed using the $(var) format:</p>

<p>[code:c#]</p>

<p>ALTER TABLE [dbo].[$(myVar1)] INSERT &hellip; VALUES ($(myVar2), $(myVar3) &hellip;)</p>

<p>[/code]</p>

<p>You can also specify these vars inside the sql script with <strong>setvar</strong>. More information in <a href="http://msdn.microsoft.com/en-us/library/ms188714.aspx">this MSDN article (Using sqlcmd with Scripting Variables).</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/10/nunit-framework-assembly-not-found/">nunit.framework Assembly Not Found</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-10T04:03:00-07:00" pubdate data-updated="true">Jun 10<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I ran into a FileNotFoundException lately when working with the latest NUnit release 2.5. It seems like its assemblies are not being added to the .Net Framework GAC (Global Assembly Cache), so this means that, unless you manually copy them to the same directory as you&rsquo;re working on, you&rsquo;ll have to manually add them to the GAC.</p>

<p>There is a well explained reply in <a href="http://stackoverflow.com/questions/176850/nunit-assembly-not-found">StackOverflow</a> (again) telling how to use the &ldquo;gacutil&rdquo; to solve this. Basically all you have to do is unregister all your old versions of NUnit (if any) and then use gacutil /i to register the assemblies.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/09/serializing-anonymous-types-in-net/">Serializing Anonymous Types in .Net</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-09T00:56:00-07:00" pubdate data-updated="true">Jun 9<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In C#, you are not able to serialize an object that does not have a parameterless constructor. At least, XmlSerializer is not able to do this. It seems like BinaryFormatter is able, as per this <a href="http://stackoverflow.com/questions/267724/why-serializable-class-need-a-parameterless-constructor">StackOverflow question</a>.</p>

<p>This means you are not able to Xml serialize some object like this, also:</p>

<p>[code:c#]</p>

<p>var myObj = new</p>

<p>{</p>

<p>MyPropertyString = &ldquo;prop1value&rdquo;,</p>

<p>MyPropertyInt = 2,</p>

<p>MyPropertyList = new List<string> { &ldquo;bananas&rdquo;, &ldquo;apples&rdquo;, &ldquo;pees&rdquo; }</p>

<p>});</p>

<p>[/code]</p>

<p>I needed to be able to serialize this kind of object to database in a human-readable format so, if you don&rsquo;t need to output in Xml format specifically, you can try this great <a href="http://james.newtonking.com/projects/json-net.aspx">Json.NET library</a> by James Newton-King, that worked smoothly for me, as easy as:</p>

<p>[code:c#]</p>

<p>string jsonString = JsonConvert.SerializeObject(_myObj);</p>

<p>[/code]</p>

<p>Surely you can do many other things with this library, which you can find out by yourself.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/05/sql-server-express-nightmare/">SQL Server Express Nightmare</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-05T10:19:00-07:00" pubdate data-updated="true">Jun 5<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Whoever tried to use SQL Server Express for any medium sized project, has probably experienced some really painful problems accessing the database file.</p>

<p>Express is a free version of this well known Microsoft database engine which is targeted for smaller business. It has some <a href="http://www.microsoft.com/sqlserver/2005/en/us/compare-features.aspx">limitations</a> when compared to the other enterprise-targeted versions.</p>

<p>One of its key differences is that, unlike the other versions, you don&rsquo;t need a database instance to start working. The only thing you need is an empty MDF file to start off. It can be created from Visual Studio (Add New Item > SQL Server Database) and you&rsquo;re ready to go. However, here is where the problems start&hellip;</p>

<p>The big issue is that the MDF is a regular windows file, like any other. This means that <strong>only one process is able to modify it at a time</strong>.</p>

<p>If you use Visual Studio and/or SQL Server Management Studio regularly, you have probably run into this error when working with SQL Server Express:</p>

<p><img src="/images/2009/6/image.axd.png" alt="" /></p>

<p>There are several reason reasons that could cause this. Here are two that I found most recurring:</p>

<p><strong>Cause 1.</strong> The NETWORK SERVICE user is not able to open the database file because it does not have rights to do so.</p>

<p><strong>Solution 1.</strong> Edit the file permissions and grant Read/Write rights to it: Right mouse click on file or containing folder > Security > Advanced > Edit</p>

<p>If the NETWORK SERVICE is already on the list, make sure it has read/write permission.</p>

<p>Else, click Add&hellip; and type NETWORK SERVICE in the edit field. Add the proper permissions and click Ok in all the open Windows. Reload the webpage.</p>

<p>In some machines, I&rsquo;ve seen the user IIS_IUSRS instead of NETWORK SERVICE, so you can try this one as well. (if it exists)</p>

<p><strong>Cause 2.</strong> Visual Studio is locking the database file. In some cases, when you edit the database inside VS using the Server Explorer window, the handle remais open even after you close the connection with the database.</p>

<p><strong>Solution 2.</strong> If your Visual Studio is open, go to the Server Explorer window and make sure the database connection closed.</p>

<p><img src="/images/2009/6/Sem+t%c3%adtulo.png" alt="" /></p>

<p>If you are using SQL Server Management Studio Express, you have to Detach the database (do not forget to check the checkbox &ldquo;Drop Connections&rdquo; in the subsequent screen):</p>

<p><img src="/images/2009/6/Sem+t%c3%adtulo2.png" alt="" /></p>

<p>Go to your webpage and try reloading it.  It should work now. In case it doesn&rsquo;t work, try closing your Solution inside VS or close the whole VS window. I&rsquo;ve seen cases where VS keeps the database locked even after you closed the connection in the Server Explorer. Unfortunately, the error above isn&rsquo;t related to an open connection and this is why it sometimes it gets really hard to diagnose the issue.</p>

<p>As I said before, only one connection may be open with the SQL Express database file at a time, so always make sure there is no other program with it open. This does not mean that it does not allow concurrent users using the database, but Visual Studio and Management Studio manage to open it in such a way that locks the file entirely. The reason is unknown to me.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/05/29/more-on-the-entity-framework/">More on the Entity Framework</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-05-29T04:56:00-07:00" pubdate data-updated="true">May 29<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my last blog post I wrote a quick introduction on the Entity Framework. I&rsquo;ve been playing with it for the last couple days. I must say I had a bit of a hard time trying to make it work. The good part is that I discovered some nice stuff when searching for solutions.</p>

<p>With Linq, you are able to build a query predicate dinamically with the extension method IQueryable<TSource> Where<TSource>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var queryResults = from p in db.Products;
</span><span class='line'>                   select p;
</span><span class='line'>queryResults = queryResults.Where(p =&gt; p.Price &lt; 1000);</span></code></pre></td></tr></table></div></figure>


<p>But what happens if later your business logic finds out that you need to include in your results products which also cost more than $3000?</p>

<p>No problem! Just call &ldquo;Where&rdquo; again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(...)
</span><span class='line'>queryResults = queryResults.Where(p =&gt; p.Price &gt; 3000);</span></code></pre></td></tr></table></div></figure>


<p>Right? <strong>NO! </strong>This would result in a query that filters the products for Price &lt; 1000 <strong>AND</strong> Price > 3000. That means, you won&rsquo;t get any results at all! :) What you need, is an <strong>OR</strong> operator between your two Where predicates.</p>

<p>The solution for this is the <a href="http://www.albahari.com/nutshell/linqkit.aspx">LinqKit</a>! It comes with a neat pack of tools for Linq, including a <a href="http://www.albahari.com/nutshell/predicatebuilder.aspx">PredicateBuilder</a> with some extension method that allow you to do something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(...)
</span><span class='line'>var queryResults = from p in db.Products;
</span><span class='line'>                   select p;
</span><span class='line'>
</span><span class='line'>var predicate = PredicateBuilder.False&lt;Product&gt;();
</span><span class='line'>predicate = predicate.Or(p =&gt; p.Price &lt; 1000);
</span><span class='line'>predicate = predicate.Or(p =&gt; p.Price &gt; 3000);
</span><span class='line'>queryResults = queryResults.AsExpandable().Where(predicate);  // p.Price &lt; 1000 OR p.Price &gt; 3000</span></code></pre></td></tr></table></div></figure>


<p>You must have noticed the AsExpandable() call above. As per LinqKit documentation:</p>

<p>&ldquo;Entity Framework&rsquo;s query processing pipeline cannot
handle <em>invocation</em> <em>expressions</em>, which is why you need to call <strong>
AsExpandable</strong> on the first object in the query. By calling AsExpandable, you
activate LINQKit&rsquo;s expression visitor class which substitutes invocation
expressions with simpler constructs that Entity Framework can understand.&rdquo;</p>

<p>The Entity Framework has some limitations when compared with Linq to SQL so that some method are not supported. You can check out that is supported and what is not <a href="http://msdn.microsoft.com/en-us/library/bb738550.aspx">here</a>.</p>

<p>If one attempts to use any of these unsupported methods, a runtime exception will be thrown.</p>

<p>PS: Thanks to <a href="http://www.coderesearchcenter.com/post/How-to-format-code-with-blogenginenet.aspx">this blog post</a>, I was able to write nice formatted C# source code in this post.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/05/20/net-framework-4-and-ado-net-futures/">.Net Framework 4 and ADO.Net Futures</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-05-20T15:13:00-07:00" pubdate data-updated="true">May 20<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Microsoft has been working on the next version of its .Net Framework 4.0 and the respective IDE: Visual Studio 2010. There is a <a href="http://channel9.msdn.com/shows/10-4/10-4-Episode-20-Downloading-and-Installing-Visual-Studio-2010-Beta-1/">video screencast</a> at Channel9 for downloading and installing the Beta 1.</p>

<p>Some of the new features in this version 4 are: parallel programming support, functional programming with <a href="http://research.microsoft.com/en-us/um/cambridge/projects/fsharp/default.aspx">F#</a>, <a href="http://msdn.microsoft.com/en-us/devlabs/dd491992.aspx">code contracts</a>, <a href="http://channel9.msdn.com/shows/10-4/10-4-Episode-16-Windows-Workflow-4/">new WF engine</a>, etc.</p>

<p>One of the biggest improvements I found very useful was the <a href="http://www.asp.net/dynamicdata/">ASP.NET Dynamic Data</a> framework, which was introduced in .Net 3.5 SP1. With this tool, you are able to create an entire data driven website in minutes. It uses Linq to SQL to generate the object/relational data mapping and then builds up pages based on columns data types. There are several built-in Field Templates and Page Templates that are used to build the pages dynamically based on the table schema. Fantastic!</p>

<p>The Dynamic Data Preview 4 can be downloaded from <a href="http://aspnet.codeplex.com/Release/ProjectReleases.aspx?ReleaseId=27026">CodePlex.</a></p>

<p>However, Microsoft also introduced the ADO.Net Entity Framework (or Linq to Entities) in .Net 3.5 SP1 as well, that seems to do the same job that L2S proposes to do. There are some discussions in the web around this. <a href="http://blogs.msdn.com/swiss_dpe_team/archive/2008/11/06/entity-framework-vs-linq-to-sql.aspx">This blog post</a> outlines the main differences between the two technologies. which basically tells us that L2S is more limited that the Entity Framework.</p>

<p>Finally, &ldquo;&hellip; as of .NET 4.0, LINQ to Entities will be the recommended data access solution for LINQ to relational scenarios.&rdquo; (<a href="http://stackoverflow.com/questions/8676/entity-framework-vs-linq-to-sql">source</a>)</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/6/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/4/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/03/31/starting-with-android-managing-images/">Starting with Android - managing images</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/31/when-two-identical-strings-are-different/">When two identical strings are different?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/14/getting-started-with-chef/">Getting started with Chef</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/05/protip-delete-words-on-iterm2-mac-osx/">Protip: Delete words on iTerm2 (Mac OSX)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/24/wombat-0-4-0-released/">Wombat 0.4.0 released!</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/felipecsl">@felipecsl</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'felipecsl',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<a href="mailto:felipe.lima@gmail.com" title="Pair program with me!">
  <img  src="http://pairprogramwith.me/badge.png"
        alt="Pair program with me!" style="width: 150px" />
</a>
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Felipe Lima -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
